<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.65, maximum-scale=1.0, user-scalable=no">
    <title>รายได้จาก Catbox</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>คำนวณรายได้จาก Catbox</h1>

    <div style="text-align: center;">
        <a href="https://line.me/ti/g/HxzDO8FMZF" style="display: inline-flexbox ; padding: 8px 20px; background-color: hsl(160, 71%, 46%); color: rgb(3, 3, 3); text-decoration: none; border-radius: 5px; margin-bottom: 10px;">
            กลุ่มแจ้งเตือนราคาจากไลน์ 
        </a>
    </div>

    <div style="text-align: center;">
        <a href="https://t.me/CatBoxGame_bot/app?startapp=WAFPC" style="display: inline-block; padding: 8px 20px; background-color: #367cff; color: rgb(255, 255, 255); text-decoration: none; border-radius: 5px; margin-bottom: px;">
            Start Catbox (เข้าเกม)
        </a>
    </div>

<div style="text-align: center;">
   <span style="display: inline-block; padding: 10px 20px; color: black; text-decoration: none; border-radius: 5px; margin-bottom: 10px; word-wrap: break-word; max-width: 90%; word-break: break-word;">
    Donate 
    <img src="ton-icon.svg" alt="Ton Icon" style="vertical-align: middle; width: 20px; height: 20px; margin-right: 10px; display: inline-block;">
    UQAvQ6XYxxgcD2J1jcIR5znk9Nl9m83xG4lBqrY8PTHlOmYr  <a href="https://t.me/user984511542" style="color: #367cff; text-decoration: none;">ติดต่อ</a>
    </span>
</div>

    <div class="result">
        <div class="info-box">
            <strong>ราคา 1 Catbox :</strong>
            <span id="catbox-price"></span>
        </div>
        <br>
        <div class="info-box">
            <strong>ราคา 1 Toncoin :</strong>
            <span id="toncoin-price"></span>
        </div>
        <br>
        <div class="info-box">
            <strong>ราคา 1 Box :</strong>
            <span id="box-price"></span>
        </div>
        <br>
        <div class="info-box">
            <strong>อัตราส่วน :</strong>
            <span id="exchange-ratio"></span>
        </div>
        <br>
        <div class="info-box">
            <strong>อัตราแลกเปลี่ยน USD/THB :</strong>
            <span id="usd-thb-rate"></span>
        </div>
    </div>

    <form id="income-form">
        <label for="catbox_per_day">แรงขุด Catbox ต่อวัน:</label>
        <input type="number" id="catbox_per_day" name="catbox_per_day" required min="0" step="0.000000001">
        <input type="submit" value="คำนวณ">
    </form>

    <div class="result" id="income-results" style="display: none;">
        <h2>ผลลัพธ์รายได้รายวัน</h2>
        <table id="income-table">
            <tr>
                <th>วันที่</th>
                <th>เหรียญ CatBox</th>
                <th>เหรียญ Toncoin</th>
                <th>รายได้ (USD)</th>
                <th>รายได้ (THB)</th>
            </tr>
        </table>
    </div>

    <script>
        
        async function fetchCatboxPrice() {
            const response = await fetch("https://api.dexscreener.com/latest/dex/pairs/ton/EQDq1cQKb6vQItJgBhwn7bS2FpJNnDLOKDUIBF8hHJgQwqlD");        
            const data = await response.json();
            return data.pair.priceUsd;
        }

        async function fetchToncoinPrice() {
            const response = await fetch("https://tonapi.io/v2/rates?tokens=ton&currencies=usd");
            const data = await response.json();
            return data.rates.TON.prices.USD;
        }

        async function fetchExchangeRate() {
    try {

        const response = await fetch("https://api.wise.com/v1/rates?source=USD&target=THB", {
            headers: {
                "Authorization": "Basic OGNhN2FlMjUtOTNjNS00MmFlLThhYjQtMzlkZTFlOTQzZDEwOjliN2UzNmZkLWRjYjgtNDEwZS1hYzc3LTQ5NGRmYmEyZGJjZA=="
            }
        });

        if (!response.ok) {
            throw new Error("Too many requests or another error from Wise API.");
        }

        const data = await response.json();
        return { rate: data[0].rate, source: "Wise" };
    } catch (error) {

        try {
            const fallbackResponse = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=thb");
            const fallbackData = await fallbackResponse.json();

            if (!fallbackData || !fallbackData.tether || !fallbackData.tether.thb) {
                throw new Error("CoinGecko API response error.");
            }

            return { rate: fallbackData.tether.thb, source: "CoinGecko" };
        } catch (fallbackError) {
            console.error("Both APIs failed:", fallbackError);
            return null;
        }
    }
}

async function updatePrices() {
            try {
                const catboxPriceUSD = await fetchCatboxPrice();
                const toncoinPriceUSD = await fetchToncoinPrice();
                const exchangeRateData = await fetchExchangeRate();

                const usdToThbRate = exchangeRateData?.rate || 0;
                const source = exchangeRateData?.source || "ไม่สามารถดึงข้อมูลได้ รอสักครู่และรีเฟรชใหม่";

                const catboxPriceUSDValid = parseFloat(catboxPriceUSD);
                const toncoinPriceUSDValid = parseFloat(toncoinPriceUSD);
                const usdToThbRateValid = parseFloat(usdToThbRate);

                const catboxPriceTHB = catboxPriceUSDValid * usdToThbRateValid;
                const toncoinPriceTHB = toncoinPriceUSDValid * usdToThbRateValid;

                const catboxPerToncoin = toncoinPriceUSDValid / catboxPriceUSDValid;
                const toncoinPerCatbox = catboxPriceUSDValid / toncoinPriceUSDValid;

                // คำนวณราคา 1 Box ในหน่วย Ton, USD และ THB
                const boxPriceTon = 52.26 / catboxPerToncoin;
                const boxPriceUSD = boxPriceTon * toncoinPriceUSDValid;
                const boxPriceTHB = boxPriceUSD * usdToThbRateValid;

                // แสดงผล
                document.getElementById("catbox-price").textContent = `${catboxPriceUSDValid.toFixed(4)} USD / ${catboxPriceTHB.toFixed(2)} THB`;
                document.getElementById("toncoin-price").textContent = `${toncoinPriceUSDValid.toFixed(4)} USD / ${toncoinPriceTHB.toFixed(2)} THB`;
                document.getElementById("exchange-ratio").textContent = `1 Ton = ${catboxPerToncoin.toFixed(4)} Catbox / 1 Catbox = ${toncoinPerCatbox.toFixed(4)} Ton`;
                document.getElementById("usd-thb-rate").textContent = `1 USD = ${usdToThbRateValid.toFixed(2)} THB (${source})`;
                
                document.getElementById("box-price").textContent = `${boxPriceTon.toFixed(4)} TON / ${boxPriceUSD.toFixed(4)} USD / ${boxPriceTHB.toFixed(2)} THB`;

                return { catboxPriceUSD: catboxPriceUSDValid, toncoinPriceUSD: toncoinPriceUSDValid, usdToThbRate: usdToThbRateValid };
            } catch (error) {
                console.error("Error fetching data:", error);
                
                document.getElementById("catbox-price").textContent = "ดึงข้อมูลไม่ได้ รอสักครู่แล้วลองใหม่";
                document.getElementById("toncoin-price").textContent = "ดึงข้อมูลไม่ได้ รอสักครู่แล้วลองใหม่";
                document.getElementById("exchange-ratio").textContent = "ดึงข้อมูลไม่ได้ รอสักครู่แล้วลองใหม่";
                document.getElementById("usd-thb-rate").textContent = "ดึงข้อมูลไม่ได้ รอสักครู่แล้วลองใหม่";
                document.getElementById("box-price").textContent = "ดึงข้อมูลไม่ได้ รอสักครู่แล้วลองใหม่";
            }
        }

        updatePrices();
    </script>
</body>
</html>
